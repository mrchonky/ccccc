<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapSwan Trading Competition Leaderboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: #a0a0ff;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .leaderboard-header {
            display: grid;
            grid-template-columns: 50px 180px 300px 120px 120px 100px;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #a0a0ff;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .leaderboard-row {
            margin-bottom: 12px;
        }

        .row-main {
            display: grid;
            grid-template-columns: 50px 180px 300px 120px 120px 100px;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .row-main:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(5px);
        }

        .leaderboard-row.rank-1 .row-main {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .leaderboard-row.rank-2 .row-main {
            border-left-color: #c0c0c0;
            background: rgba(192, 192, 192, 0.1);
        }

        .leaderboard-row.rank-3 .row-main {
            border-left-color: #cd7f32;
            background: rgba(205, 127, 50, 0.1);
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
        }

        .rank-1 .rank { color: #ffd700; }
        .rank-2 .rank { color: #c0c0c0; }
        .rank-3 .rank { color: #cd7f32; }
        .rank { color: #a0a0ff; }

        .trader-name {
            font-weight: bold;
            color: white;
            font-size: 1.1em;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            color: #8888ff;
            font-size: 0.85em;
        }

        .balance {
            font-size: 1.1em;
            font-weight: bold;
            text-align: right;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .total-deposits {
            font-size: 1.1em;
            font-weight: bold;
            text-align: right;
            color: #ffa500;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
        }

        .roi {
            font-size: 1.4em;
            font-weight: bold;
            text-align: right;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .roi.positive {
            color: #00ff88;
        }

        .roi.negative {
            color: #ff4444;
        }

        .roi.neutral {
            color: #ffaa00;
        }

        .positions-detail {
            display: none;
            margin-top: 10px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .positions-detail.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .positions-title {
            color: #a0a0ff;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .position-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .position-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .position-label {
            color: #888;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .position-value {
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .position-value.long {
            color: #00ff88;
        }

        .position-value.short {
            color: #ff4444;
        }

        .no-positions {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .loading {
            color: #888;
            font-style: italic;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            align-items: center;
        }

        .refresh-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .last-updated {
            color: #a0a0ff;
            font-size: 0.9em;
        }

        @media (max-width: 1200px) {
            .leaderboard-header, .row-main {
                grid-template-columns: 40px 140px 250px 100px 100px 80px;
                font-size: 0.85em;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .leaderboard-header {
                display: none;
            }

            .row-main {
                grid-template-columns: 40px 1fr;
                gap: 10px;
            }

            .trader-name, .wallet-address, .balance, .total-deposits, .roi {
                grid-column: 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Trading Competition Leaderboard</h1>
            <div class="subtitle">powered by capswan.app</div>
        </div>
        
        <div class="leaderboard" id="leaderboard">
            <div class="loading">Loading leaderboard...</div>
        </div>

        <div class="controls">
            <button class="refresh-btn" id="refreshBtn" onclick="fetchAllBalances()">üîÑ Refresh</button>
            <div class="last-updated" id="last-updated"></div>
        </div>
    </div>

    <script>
        const traders = [
            { name: 'danupsher', address: '0x3eA398e5b4BA26C920b53bf05a97B1aB6cE4343C' },
            { name: 'The Firemun', address: '0x068dE891CB8DE497A18afe13e55918b19a29acfB' },
            { name: '__methoxy', address: '0x12eCad7E9F86710934dBb8FdFaD883F15eac4AC2' },
            { name: 'ace', address: '0x7630e2Bf1086272D9541f5c35C04043F5030271B' },
            { name: '~$üÖ±robot#1984', address: '0xD4966bAc9C3221ADc62B073E93d80fd6d4275fD0' },
            { name: 'ZKXBT', address: '0xF8B40Fe173251b4cd414ce311265c071d408629E' },
            { name: 'Flip', address: '0xDCd94a350266BD8dfd7597576878ad076D5505cB' },
            { name: 'trading_peter', address: '0x5d79E83F1015D05A5868272978bf2c02cFD8f4Dc' },
            { name: 'Mr. Chonky', address: '0x4d23A63496b06566750f18cECa6EEe538d5AE0ee' },
            { name: 'bitfloorsghost', address: '0x38Fa10b8f3F5739Ff0F07180F12358A6624f4e8E' }
        ];

        async function fetchAllMids() {
            try {
                // Fetch allMids - the response is already a mapping of coin name to price
                const midsResponse = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'allMids'
                    })
                });

                const midsData = await midsResponse.json();
                
                // The mids data is already a mapping from coin name to price
                return midsData;
            } catch (error) {
                return {};
            }
        }

        async function fetchBalance(address) {
            try {
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'clearinghouseState',
                        user: address
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return {
                    balance: parseFloat(data.marginSummary.accountValue),
                    positions: data.assetPositions || []
                };
            } catch (error) {
                return { balance: 0, positions: [] };
            }
        }

        async function fetchOpenOrders(address) {
            try {
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'frontendOpenOrders',
                        user: address
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data || [];
            } catch (error) {
                return [];
            }
        }

        async function fetchNetDeposits(address) {
            try {
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'userNonFundingLedgerUpdates',
                        user: address
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let totalDeposits = 0;
                let totalWithdrawals = 0;
                let initialDeposit = 0;
                let firstDepositFound = false;

                const sortedData = data.sort((a, b) => a.time - b.time);

                sortedData.forEach(update => {
                    if (update.delta) {
                        const amount = parseFloat(update.delta.usdc || 0);
                        
                        if (update.delta.type === 'deposit') {
                            totalDeposits += amount;
                            if (!firstDepositFound && amount > 0) {
                                initialDeposit = amount;
                                firstDepositFound = true;
                            }
                        } else if (update.delta.type === 'withdraw') {
                            totalWithdrawals += Math.abs(amount);
                        } else if (update.delta.type === 'accountClassTransfer') {
                            if (update.delta.toPerp === true) {
                                totalDeposits += amount;
                                if (!firstDepositFound && amount > 0) {
                                    initialDeposit = amount;
                                    firstDepositFound = true;
                                }
                            } else {
                                totalWithdrawals += amount;
                            }
                        }
                    }
                });

                return { totalDeposits, totalWithdrawals, initialDeposit };
            } catch (error) {
                return { totalDeposits: 0, totalWithdrawals: 0, initialDeposit: 0 };
            }
        }

        async function fetchAllBalances() {
            const leaderboard = document.getElementById('leaderboard');
            const refreshBtn = document.getElementById('refreshBtn');
            
            leaderboard.innerHTML = '<div class="loading">Loading leaderboard...</div>';
            refreshBtn.disabled = true;

            // Fetch market prices first
            const allMids = await fetchAllMids();

            const tradersWithData = await Promise.all(
                traders.map(async (trader) => {
                    const { balance, positions } = await fetchBalance(trader.address);
                    const { totalDeposits, totalWithdrawals, initialDeposit } = await fetchNetDeposits(trader.address);
                    const openOrders = await fetchOpenOrders(trader.address);
                    
                    // Calculate ROI based on Total Deposits (more transparent)
                    // ROI = (Current Balance - Total Deposits) / Total Deposits √ó 100
                    let roi = 0;
                    
                    if (totalDeposits > 0) {
                        roi = ((balance - totalDeposits) / totalDeposits) * 100;
                    }
                    
                    // Add mids to each trader for rendering
                    return { ...trader, balance, totalDeposits, initialDeposit, roi, positions, openOrders, mids: allMids };
                })
            );

            tradersWithData.sort((a, b) => b.roi - a.roi);

            // Store allMids globally for use in rendering
            window.currentMids = allMids;

            let html = '<div class="leaderboard-header">';
            html += '<div>Rank</div>';
            html += '<div>Trader</div>';
            html += '<div>Address</div>';
            html += '<div style="text-align: right;">Balance</div>';
            html += '<div style="text-align: right;">Total Deps</div>';
            html += '<div style="text-align: right;">ROI</div>';
            html += '</div>';
            
            tradersWithData.forEach((trader, index) => {
                const rank = index + 1;
                const rankClass = `rank-${rank <= 3 ? rank : ''}`;
                
                let roiClass = 'neutral';
                if (trader.roi > 0) roiClass = 'positive';
                else if (trader.roi < 0) roiClass = 'negative';
                
                const roiDisplay = trader.totalDeposits > 0 
                    ? `${trader.roi > 0 ? '+' : ''}${trader.roi.toFixed(1)}%`
                    : 'N/A';
                
                html += `
                    <div class="leaderboard-row ${rankClass}">
                        <div class="row-main" onclick="togglePositions('trader-${index}', ${index})">
                            <div class="rank">#${rank}</div>
                            <div class="trader-name">${trader.name}</div>
                            <div class="wallet-address">${trader.address}</div>
                            <div class="balance">${trader.balance.toFixed(2)}</div>
                            <div class="total-deposits">${trader.totalDeposits.toFixed(2)}</div>
                            <div class="roi ${roiClass}">${roiDisplay}</div>
                        </div>
                        <div class="positions-detail" id="trader-${index}"></div>
                    </div>
                `;
            });

            leaderboard.innerHTML = html;
            
            // Store traders data globally for dynamic rendering
            window.tradersData = tradersWithData;
            
            document.getElementById('last-updated').textContent = 
                `Last updated: ${new Date().toLocaleString()}`;
            
            refreshBtn.disabled = false;
        }

        function renderPositions(positions, allMids) {
            if (!positions || positions.length === 0) {
                return '<div class="no-positions">No open positions</div>';
            }

            let html = '<div class="positions-title">üìä Open Positions</div>';
            
            positions.forEach(pos => {
                const position = pos.position;
                const szi = parseFloat(position.szi);
                const side = szi > 0 ? 'LONG' : 'SHORT';
                const sideClass = szi > 0 ? 'long' : 'short';
                const entryPrice = parseFloat(position.entryPx);
                const positionValue = Math.abs(parseFloat(position.positionValue));
                const unrealizedPnl = parseFloat(position.unrealizedPnl);
                const pnlClass = unrealizedPnl >= 0 ? 'long' : 'short';
                const leverage = position.leverage.value;
                const currentPrice = allMids[position.coin] ? parseFloat(allMids[position.coin]) : null;

                html += `
                    <div class="position-card">
                        <div class="position-field">
                            <div class="position-label">Asset</div>
                            <div class="position-value">${position.coin}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Side</div>
                            <div class="position-value ${sideClass}">${side}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Size</div>
                            <div class="position-value">${Math.abs(szi).toFixed(4)}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Leverage</div>
                            <div class="position-value">${leverage}x</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Position Value</div>
                            <div class="position-value">${positionValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Entry Price</div>
                            <div class="position-value">${entryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Live Price</div>
                            <div class="position-value">${currentPrice ? currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6}) : 'N/A'}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Price Change</div>
                            <div class="position-value ${currentPrice ? (currentPrice >= entryPrice ? 'long' : 'short') : ''}">${currentPrice ? ((currentPrice - entryPrice) / entryPrice * 100).toFixed(2) + '%' : 'N/A'}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Unrealized PnL</div>
                            <div class="position-value ${pnlClass}">${unrealizedPnl >= 0 ? '+' : ''}${unrealizedPnl.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">PnL %</div>
                            <div class="position-value ${pnlClass}">${unrealizedPnl >= 0 ? '+' : ''}${((unrealizedPnl / positionValue) * 100).toFixed(2)}%</div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function renderOpenOrders(orders) {
            if (!orders || orders.length === 0) {
                return '';
            }

            let html = '<div class="positions-title" style="margin-top: 20px;">üìã Open Orders</div>';
            
            orders.forEach(order => {
                // Handle different side formats: 'B'/'A' or 'BUY'/'SELL'
                const side = (order.side === 'B' || order.side === 'BUY') ? 'BUY' : 'SELL';
                const sideClass = (order.side === 'B' || order.side === 'BUY') ? 'long' : 'short';
                const limitPrice = parseFloat(order.limitPx);
                
                // Use isTrigger flag and triggerPx from frontendOpenOrders endpoint
                const isTrigger = order.isTrigger === true;
                const triggerPrice = isTrigger && order.triggerPx && parseFloat(order.triggerPx) > 0 
                    ? parseFloat(order.triggerPx) 
                    : null;
                
                const size = parseFloat(order.sz);
                const timestamp = new Date(order.timestamp).toLocaleString();
                const isReduceOnly = order.reduceOnly === true;
                const isPositionTpsl = order.isPositionTpsl === true;
                
                // Determine order type
                let orderType = order.orderType || 'Limit';
                if (isReduceOnly && !isPositionTpsl) {
                    orderType += ' (Reduce Only)';
                }
                if (isPositionTpsl) {
                    orderType = 'TP/SL';
                }

                html += `
                    <div class="position-card">
                        <div class="position-field">
                            <div class="position-label">Asset</div>
                            <div class="position-value">${order.coin}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Type</div>
                            <div class="position-value">${orderType}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Side</div>
                            <div class="position-value ${sideClass}">${side}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Size</div>
                            <div class="position-value">${size.toFixed(4)}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Order Value</div>
                            <div class="position-value">${(size * limitPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                        ${triggerPrice ? `
                        <div class="position-field">
                            <div class="position-label">Trigger SL</div>
                            <div class="position-value" style="color: #ffaa00;">${triggerPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}</div>
                        </div>
                        ` : ''}
                        <div class="position-field">
                            <div class="position-label">Limit SL</div>
                            <div class="position-value">${limitPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Time</div>
                            <div class="position-value" style="font-size: 0.9em;">${timestamp}</div>
                        </div>
                        <div class="position-field">
                            <div class="position-label">Order ID</div>
                            <div class="position-value" style="font-size: 0.9em;">${order.oid}</div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function togglePositions(id, traderIndex) {
            const element = document.getElementById(id);
            
            // If already active, just close it
            if (element.classList.contains('active')) {
                element.classList.remove('active');
                element.innerHTML = ''; // Clear content when closing
                return;
            }
            
            // Render positions dynamically with fresh data
            const trader = window.tradersData[traderIndex];
            
            const positionsHTML = renderPositions(trader.positions, trader.mids);
            const ordersHTML = renderOpenOrders(trader.openOrders);
            
            element.innerHTML = positionsHTML + ordersHTML;
            element.classList.add('active');
        }

        fetchAllBalances();
        setInterval(fetchAllBalances, 60000);
    </script>
</body>
</html>